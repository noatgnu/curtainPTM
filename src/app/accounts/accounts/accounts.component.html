<div class="modal-header">
  <h5 class="modal-title">Account Information</h5>
</div>
<div class="modal-body">
  @if (errorMessage) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>{{errorMessage}}
      <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
    </div>
  }

  <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" (activeIdChange)="onTabChange($event)" class="nav-tabs mb-3">
    <li [ngbNavItem]="1">
      <button ngbNavLink>
        <i class="bi bi-collection me-1"></i>Sessions
      </button>
      <ng-template ngbNavContent>

  <div class="card mb-3">
    <div class="card-body">
      <h6 class="card-subtitle mb-2 text-muted">User Details</h6>
      <div class="row">
        <div class="col-md-4">
          <strong>Username:</strong> {{accounts.curtainAPI.user.username}}
        </div>
        <div class="col-md-4">
          <strong>Link Limit:</strong> 
          @if (accounts.curtainAPI.user.curtainLinkLimit === 0) {
            <span class="badge bg-success">Unlimited</span>
          } @else {
            <span class="badge" [class.bg-danger]="accounts.curtainAPI.user.curtainLinkLimitExceeded" [class.bg-info]="!accounts.curtainAPI.user.curtainLinkLimitExceeded">
              {{accounts.curtainAPI.user.curtainLinkLimit}}
            </span>
          }
          @if (accounts.curtainAPI.user.curtainLinkLimitExceeded) {
            <span class="text-danger ms-1"><i class="bi bi-exclamation-circle"></i> Limit Exceeded</span>
          }
        </div>
        <div class="col-md-4">
          <strong>Total Sessions:</strong> <span class="badge bg-primary">{{accounts.curtainAPI.user.totalCurtain}}</span>
        </div>
      </div>
    </div>
  </div>

  <form [formGroup]="form" (submit)="$event.preventDefault()">
    <div class="form-group mb-3">
      <label for="session-search" class="form-label">Search Session Description</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input 
          type="text" 
          formControlName="sessionDescription" 
          id="session-search" 
          class="form-control"
          placeholder="Type to search...">
        @if (form.get('sessionDescription')?.value) {
          <button 
            class="btn btn-outline-secondary" 
            type="button"
            (click)="form.get('sessionDescription')?.setValue('')">
            <i class="bi bi-x"></i>
          </button>
        }
      </div>
    </div>
  </form>
  @if (isLoading) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Loading sessions...</p>
    </div>
  }

  @if (!isLoading && totalItems === 0) {
    <div class="alert alert-info text-center">
      <i class="bi bi-info-circle me-2"></i>
      @if (form.get('sessionDescription')?.value) {
        No sessions found matching your search criteria.
      } @else {
        You don't have any sessions yet.
      }
    </div>
  }

  @if (!isLoading && totalItems > 0) {
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        @if (hasSelectedLinks) {
          <span class="badge bg-info">{{selectedCount}} selected</span>
        }
      </div>
      <ngb-pagination 
        [collectionSize]="totalItems" 
        [(page)]="currentPage" 
        [maxSize]="5" 
        [boundaryLinks]="true" 
        (pageChange)="submit($event - 1)">
      </ngb-pagination>
    </div>

    <div class="table-responsive">
      <table class="table table-hover table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col" style="width: 50px;">
              <input
                type="checkbox"
                class="form-check-input"
                [checked]="allSelected"
                (change)="toggleSelectAll()"
                title="Select all">
            </th>
            <th scope="col" style="width: 200px;">Link ID</th>
            <th scope="col">Description</th>
            <th scope="col" style="width: 120px;">Status</th>
            <th scope="col" style="width: 100px;">DOI</th>
            <th scope="col" style="width: 200px;">
              <div ngbDropdown class="d-inline-block">
                <button 
                  class="btn btn-sm btn-outline-primary" 
                  id="accountSelectedLinksAction" 
                  ngbDropdownToggle
                  [disabled]="!hasSelectedLinks">
                  <i class="bi bi-gear me-1"></i>Actions
                </button>
                <div ngbDropdownMenu aria-labelledby="accountSelectedLinksAction">
                  <h6 class="dropdown-header">Bulk Actions</h6>
                  <div class="px-3 py-2">
                    <label for="addMultipleOwner" class="form-label small">Add Owner</label>
                    <div class="input-group input-group-sm">
                      <input 
                        type="text" 
                        placeholder="Username" 
                        id="addMultipleOwner" 
                        class="form-control" 
                        #allowner>
                      <button 
                        class="btn btn-primary" 
                        (click)="addOwnerToSelectedLinks(allowner.value); allowner.value = ''">
                        Add
                      </button>
                    </div>
                  </div>
                  <div class="dropdown-divider"></div>
                  <button ngbDropdownItem (click)="changePublicitySelectedLinks(true)">
                    <i class="bi bi-unlock me-2"></i>Set Public
                  </button>
                  <button ngbDropdownItem (click)="changePublicitySelectedLinks(false)">
                    <i class="bi bi-lock me-2"></i>Set Private
                  </button>
                  <div class="dropdown-divider"></div>
                  <button ngbDropdownItem (click)="removeSelectedLinks()" class="text-danger">
                    <i class="bi bi-trash me-2"></i>Delete Selected
                  </button>
                </div>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          @for (d of data.results; track d.link_id) {
            <tr>
              <td>
                <input 
                  type="checkbox" 
                  class="form-check-input" 
                  [(ngModel)]="selectedLinks[d.link_id]" 
                  (change)="toggleLinkSelection(d.link_id)">
              </td>
              <td>
                <a 
                  href="{{base}}/#/{{d.link_id}}" 
                  target="_blank" 
                  class="text-decoration-none">
                  <i class="bi bi-box-arrow-up-right me-1"></i>{{d.link_id}}
                </a>
              </td>
              <td>
                <div [innerHTML]="d.description" class="text-truncate" style="max-width: 400px;"></div>
                <small class="text-muted">
                  <i class="bi bi-calendar3 me-1"></i>{{d.created | date:'short'}}
                </small>
              </td>
              <td>
                @if (d.enable) {
                  <span class="badge bg-success"><i class="bi bi-unlock me-1"></i>Public</span>
                } @else {
                  <span class="badge bg-secondary"><i class="bi bi-lock me-1"></i>Private</span>
                }
              </td>
              <td>
                @if (d['doi'] || d['datacite']) {
                  <span class="badge bg-primary" title="Has DataCite DOI">
                    <i class="bi bi-check-circle me-1"></i>Yes
                  </span>
                } @else {
                  <span class="badge bg-secondary" title="No DataCite DOI">
                    <i class="bi bi-dash-circle me-1"></i>No
                  </span>
                }
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <button 
                    class="btn btn-outline-primary" 
                    (click)="viewDescription(d.link_id)"
                    title="View details">
                    <i class="bi" [class.bi-chevron-down]="!descriptionTrigger[d.link_id]" [class.bi-chevron-up]="descriptionTrigger[d.link_id]"></i>
                  </button>
                  @if (accounts.curtainAPI.user.canDelete) {
                    <button 
                      class="btn btn-outline-danger" 
                      (click)="deleteLink(d.link_id)"
                      title="Delete session">
                      <i class="bi bi-trash"></i>
                    </button>
                  }
                </div>
              </td>
            </tr>
            @if (descriptionTrigger[d.link_id]) {
              <tr class="table-light">
                <td colspan="6">
                  <div class="p-3">
                    <strong><i class="bi bi-people me-2"></i>Owners:</strong>
                    <div class="mt-2">
                      @for (o of d.owners; track o.username) {
                        <span class="badge bg-info me-1">{{o.username}}</span>
                      }
                      @if (!d.owners || d.owners.length === 0) {
                        <span class="text-muted">No additional owners</span>
                      }
                    </div>
                    @if (d['doi'] || d['datacite']) {
                      <div class="mt-3">
                        <strong><i class="bi bi-journal-check me-2"></i>DataCite DOI:</strong>
                        <div class="mt-2 d-flex align-items-center">
                          <span class="badge bg-primary me-2">
                            <i class="bi bi-check-circle me-1"></i>Published
                          </span>
                          @if (d['doi']) {
                            <a [href]="'https://doi.org/' + d['doi']" target="_blank" class="text-decoration-none">
                              <i class="bi bi-box-arrow-up-right me-1"></i>{{d['doi']}}
                            </a>
                          }
                        </div>
                      </div>
                    }
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-center mt-3">
      <ngb-pagination 
        [collectionSize]="totalItems" 
        [(page)]="currentPage" 
        [maxSize]="5" 
        [boundaryLinks]="true" 
        (pageChange)="submit($event - 1)">
      </ngb-pagination>
    </div>
  }
      </ng-template>
    </li>
    <li [ngbNavItem]="2">
      <button ngbNavLink>
        <i class="bi bi-folder2-open me-1"></i>Collections
      </button>
      <ng-template ngbNavContent>
        @if (collectionsLoading) {
          <div class="d-flex justify-content-center align-items-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        }
        <div class="card mb-3 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="card-subtitle mb-0 text-muted">Manage Collections</h6>
              <button class="btn btn-primary btn-sm" (click)="openCreateCollectionModal()" [disabled]="collectionsLoading">
                <i class="bi bi-plus-circle me-1"></i>Create Collection
              </button>
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input
                type="text"
                [(ngModel)]="collectionSearchQuery"
                (ngModelChange)="searchCollections()"
                class="form-control"
                placeholder="Search collections by name or description..."
                [disabled]="collectionsLoading">
            </div>
          </div>
        </div>
        @if (collections.length > 0) {
          <div class="d-flex justify-content-between align-items-center mb-3">
            <small class="text-muted">{{totalCollections}} Total Collections</small>
            <ngb-pagination
              [collectionSize]="totalCollections"
              [(page)]="collectionPage"
              [maxSize]="5"
              [boundaryLinks]="true"
              [size]="'sm'"
              [disabled]="collectionsLoading"
              (pageChange)="loadCollections()">
            </ngb-pagination>
          </div>
          <div class="row g-3">
            @for (collection of collections; track collection.id) {
              <div class="col-md-6">
                <div class="card h-100 shadow-sm">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="card-title mb-0">{{collection.name}}</h6>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" (click)="openEditCollectionModal(collection)" [disabled]="collectionsLoading">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" (click)="confirmDeleteCollection(collection)" [disabled]="collectionsLoading">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                    @if (collection.description) {
                      <p class="card-text text-muted small">{{collection.description}}</p>
                    }
                    <div class="d-flex justify-content-between align-items-center mt-3">
                      <span class="badge bg-info text-dark">
                        <i class="bi bi-collection me-1"></i>{{collection.curtain_count}} Sessions
                      </span>
                      <button class="btn btn-sm btn-outline-primary" (click)="viewCollectionSessions(collection)" [disabled]="collectionsLoading">
                        <i class="bi bi-eye me-1"></i>View Sessions
                      </button>
                    </div>
                    <div class="text-muted small mt-2">
                      <i class="bi bi-calendar3 me-1"></i>Updated: {{collection.updated | date:'short'}}
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="text-center py-5">
            <i class="bi bi-folder2-open display-1 text-muted"></i>
            <p class="text-muted mt-3">No collections found. Create your first collection!</p>
          </div>
        }
      </ng-template>
    </li>
    <li [ngbNavItem]="3">
      <button ngbNavLink>
        <i class="bi bi-list-ul me-1"></i>Data Filter Lists
      </button>
      <ng-template ngbNavContent>
        <app-user-lists-management></app-user-lists-management>
      </ng-template>
    </li>
  </ul>
  <div [ngbNavOutlet]="nav"></div>
</div>
