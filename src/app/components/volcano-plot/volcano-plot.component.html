
<div class="d-flex justify-content-around" role="region" aria-label="Volcano Plot Analysis">
  <div class="d-flex justify-content-center align-items-center flex-grow-1">
    <div class="d-flex flex-column">
      @if (config.editable) {
        <div class="alert alert-info" role="status" aria-live="polite">
          <p>Edit mode is currently activated</p>
          <ul>
            <li>Click on the plot title or axis title to edit them directly</li>
            <li>Data point annotations can now be freely dragged</li>
            <li>Legends can now also be freely dragged</li>
          </ul>
        </div>
      }
      <div class="volcano-plot-container" role="img" [attr.aria-label]="getPlotAriaLabel()">
        <span class="visually-hidden" id="volcanoPlotDescription">
          Volcano plot showing {{graphData.length}} data groups.
          X-axis represents log2 fold change, Y-axis represents -log10 p-value.
          Significance cutoff: p-value {{settings.settings.pCutoff}}, fold change Â±{{settings.settings.log2FCCutoff}}.
          Click or use keyboard to select data points for detailed analysis.
        </span>
        <plotly-plot
          (relayout)="handleLayoutChange($event)"
          (legendClick)="legendClickHandler($event)"
          [config]="config"
          [divId]="'volcanoPlot'"
          [data]="graphData"
          [layout]="graphLayout"
          [revision]="revision"
          [updateOnLayoutChange]="true"
          (plotlyClick)="selectData($event)"
          (selected)="selectData($event)"
          aria-describedby="volcanoPlotDescription">
        </plotly-plot>
      </div>
    </div>
  </div>
  <div class="flex-grow-0" style="max-width: 500px">
    <nav class="accordion" aria-label="Volcano Plot Settings Panel">
      <div class="accordion-item">
        <h2 class="accordion-header" id="volcanoSettingsHeader">
          <button
            [ngClass]="{'accordion-button': true, 'collapsed': isVolcanoParameterCollapsed}"
            type="button"
            (click)="isVolcanoParameterCollapsed=!isVolcanoParameterCollapsed"
            [attr.aria-expanded]="!isVolcanoParameterCollapsed"
            aria-controls="volcanoSettingsPanel">
            Volcano Plot Settings
          </button>
        </h2>
        <div #collapse="ngbCollapse" [(ngbCollapse)]="isVolcanoParameterCollapsed" id="volcanoSettingsPanel" role="region" aria-labelledby="volcanoSettingsHeader">
          <div class="accordion-body">
            <ul #nav="ngbNav" ngbNav [(activeId)]="settingsNav" class="nav-tabs" role="tablist" aria-label="Settings categories">
              <li [ngbNavItem]="'parameters'" role="presentation">
                <button ngbNavLink role="tab" aria-controls="parametersPanel">Plot Parameters</button>
                <ng-template ngbNavContent>
                  <fieldset class="mb-3" role="group" aria-label="Plot modes">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" id="editModeToggle" [(ngModel)]="editMode">
                      <label class="form-check-label" for="editModeToggle">Editable Mode (enable free movement and editing of text and other element of the plot)</label>
                    </div>
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" id="explorerModeToggle" [(ngModel)]="explorerMode">
                      <label class="form-check-label" for="explorerModeToggle">Explorer Mode (click on points to view nearby points with peptide sequences and PTM information)</label>
                    </div>
                  </fieldset>
                  <div class="d-flex">
                    <div class="p-2">
                      <label for="width">
                        Plot Width
                      </label>
                      <input id="width" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoPlotDimension.width">
                    </div>
                    <div class="p-2">
                      <label for="height">
                        Plot Height
                      </label>
                      <input id="height" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoPlotDimension.height">
                    </div>
                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <label for="marginTop">
                        Margin Top
                      </label>
                      <input id="marginTop" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoPlotDimension.margin.t">
                    </div>
                    <div class="p-2">
                      <label for="marginBottom">
                        Margin Bottom
                      </label>
                      <input id="marginBottom" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoPlotDimension.margin.b">
                    </div>

                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <label for="marginRight">
                        Margin Right
                      </label>
                      <input id="marginRight" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoPlotDimension.margin.r">
                    </div>
                    <div class="p-2">
                      <label for="marginLeft">
                        Margin Left
                      </label>
                      <input id="marginLeft" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoPlotDimension.margin.l">
                    </div>
                  </div>
                  <div>
                    <label for="xTitle">
                      X-axis Title
                    </label>
                    <input id="xTitle" type="text" class="form-control" [(ngModel)]="settings.settings.volcanoAxis.x">
                  </div>
                  <div>
                    <label for="yTitle">
                      Y-axis Title
                    </label>
                    <input id="yTitle" type="text" class="form-control" [(ngModel)]="settings.settings.volcanoAxis.y">
                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <label for="significant">
                        Significant Cutoff
                      </label>
                      <input id="significant" type="number" class="form-control" [(ngModel)]="settings.settings.pCutoff">
                    </div>
                    <div class="p-2">
                      <label for="foldchange">
                        Log2 Fold Change Cutoff
                      </label>
                      <input id="foldchange" type="number" class="form-control" [(ngModel)]="settings.settings.log2FCCutoff">
                    </div>
                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <label for="maxX">
                        Max X-axis
                      </label>
                      <input id="maxX" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoAxis.maxX">
                    </div>
                    <div class="p-2">
                      <label for="minX">
                        Min X-axis
                      </label>
                      <input id="minX" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoAxis.minX">
                    </div>

                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <label for="dtickX">
                        X-axis Tick Interval
                      </label>
                      <input id="dtickX" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoAxis.dtickX">
                    </div>
                    <div class="p-2">
                      <label for="ticklenX">
                        X-axis Tick Length
                      </label>
                      <input id="ticklenX" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoAxis.ticklenX">
                    </div>
                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <label for="maxY">
                        Max Y-axis
                      </label>
                      <input id="maxY" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoAxis.maxY">
                    </div>
                    <div class="p-2">
                      <label for="minY">
                        Min Y-axis
                      </label>
                      <input id="minY" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoAxis.minY">
                    </div>

                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <label for="dtickY">
                        Y-axis Tick Interval
                      </label>
                      <input id="dtickY" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoAxis.dtickY">
                    </div>
                    <div class="p-2">
                      <label for="ticklenY">
                        Y-axis Tick Length
                      </label>
                      <input id="ticklenY" type="number" class="form-control" [(ngModel)]="settings.settings.volcanoAxis.ticklenY">
                    </div>
                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <label for="plotTitle">
                        Plot Title
                      </label>
                      <input id="plotTitle" type="text" class="form-control" [(ngModel)]="settings.settings.volcanoPlotTitle">
                    </div>
                    <div class="p-2">
                      <label for="markerSize">Marker Size</label>
                      <input id="markerSize" type="number" class="form-control" [(ngModel)]="markerSize">
                    </div>
                  </div>
                  <div class="card mb-3">
                    <div class="card-header">
                      <button class="btn btn-link w-100 text-start text-decoration-none p-0" type="button" (click)="isConditionLabelsCollapsed = !isConditionLabelsCollapsed">
                        <i class="bi" [class.bi-chevron-down]="isConditionLabelsCollapsed" [class.bi-chevron-up]="!isConditionLabelsCollapsed"></i>
                        Condition Labels
                      </button>
                    </div>
                    <div class="card-body" [class.d-none]="isConditionLabelsCollapsed">
                      <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="enableConditionLabels" [(ngModel)]="settings.settings.volcanoConditionLabels.enabled" (change)="drawVolcano()">
                        <label class="form-check-label" for="enableConditionLabels">
                          Show condition labels on plot
                        </label>
                      </div>
                      <div class="p-2">
                        <label for="leftCondition">Left Side Condition (x &lt; 0)</label>
                        <div class="input-group" ngbDropdown>
                          <input id="leftCondition" type="text" class="form-control" [(ngModel)]="settings.settings.volcanoConditionLabels.leftCondition" (change)="drawVolcano()" placeholder="e.g., Control">
                          @if (availableConditions.length > 0) {
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" ngbDropdownToggle>
                              <i class="bi bi-list"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end" ngbDropdownMenu>
                              @for (condition of availableConditions; track condition) {
                                <button class="dropdown-item" type="button" (click)="selectLeftCondition(condition)">
                                  {{condition}}
                                </button>
                              }
                            </div>
                          }
                        </div>
                      </div>
                      <div class="p-2">
                        <label for="rightCondition">Right Side Condition (x &gt; 0)</label>
                        <div class="input-group" ngbDropdown>
                          <input id="rightCondition" type="text" class="form-control" [(ngModel)]="settings.settings.volcanoConditionLabels.rightCondition" (change)="drawVolcano()" placeholder="e.g., Treatment">
                          @if (availableConditions.length > 0) {
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" ngbDropdownToggle>
                              <i class="bi bi-list"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end" ngbDropdownMenu>
                              @for (condition of availableConditions; track condition) {
                                <button class="dropdown-item" type="button" (click)="selectRightCondition(condition)">
                                  {{condition}}
                                </button>
                              }
                            </div>
                          }
                        </div>
                      </div>

                      <hr>

                      <h6 class="mb-2">Position &amp; Style</h6>

                      <div class="d-flex">
                        <div class="p-2">
                          <label for="leftLabelX">Left Label X Position</label>
                          <input id="leftLabelX" type="number" step="0.05" min="0" max="1" class="form-control form-control-sm" [(ngModel)]="settings.settings.volcanoConditionLabels.leftX" (change)="drawVolcano()">
                          <small class="text-muted">0 (left) to 1 (right)</small>
                        </div>
                        <div class="p-2">
                          <label for="rightLabelX">Right Label X Position</label>
                          <input id="rightLabelX" type="number" step="0.05" min="0" max="1" class="form-control form-control-sm" [(ngModel)]="settings.settings.volcanoConditionLabels.rightX" (change)="drawVolcano()">
                          <small class="text-muted">0 (left) to 1 (right)</small>
                        </div>
                      </div>

                      <div class="p-2">
                        <label for="labelYPosition">Y Position</label>
                        <input id="labelYPosition" type="number" step="0.05" class="form-control form-control-sm" [(ngModel)]="settings.settings.volcanoConditionLabels.yPosition" (change)="drawVolcano()">
                        <small class="text-muted">Negative values place below plot</small>
                      </div>

                      <div class="d-flex">
                        <div class="p-2">
                          <label for="labelFontSize">Font Size</label>
                          <input id="labelFontSize" type="number" min="8" max="48" class="form-control form-control-sm" [(ngModel)]="settings.settings.volcanoConditionLabels.fontSize" (change)="drawVolcano()">
                        </div>
                        <div class="p-2">
                          <label for="labelFontColor">Font Color</label>
                          <input id="labelFontColor" type="color" class="form-control form-control-sm form-control-color" [(ngModel)]="settings.settings.volcanoConditionLabels.fontColor" (change)="drawVolcano()">
                        </div>
                      </div>

                      <hr>

                      <div class="p-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" (click)="autoAdjustConditionLabels()">
                          <i class="bi bi-arrows-move me-1"></i>Auto-Adjust to Avoid Overlap
                        </button>
                        <small class="text-muted d-block mt-1">Automatically adjusts Y position to avoid overlap with legend</small>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <div class="form-group">
                        <label class="form-check-label" for="custom-volcano-text-col">Custom Popup Label Column</label>
                        <select id="custom-volcano-text-col" [(ngModel)]="settings.settings.customVolcanoTextCol" class="form-control">
                          <option [value]="''">Default</option>
                          @for (col of dataService.differential.df.getColumnNames(); track col) {
                            <option [value]="col">{{col}}</option>
                          }
                        </select>
                        <small class="text-muted">Changes will only affect newly added annotation ids.</small>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col">
                      <div class="form-check">
                        <input type="checkbox" id="backgroundGrey" class="form-check-input" [(ngModel)]="settings.settings.backGroundColorGrey">
                        <label class="form-check-label" for="backgroundGrey">Set Background Data Points Grey</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <div class="form-check">
                        <input type="checkbox" id="showVerticalGrid" class="form-check-input" [(ngModel)]="settings.settings.volcanoPlotGrid.x">
                        <label class="form-check-label" for="showVerticalGrid">Show Vertical Grid</label>
                      </div>
                    </div>
                    <div class="p-2">
                      <div class="form-check">
                        <input type="checkbox" id="showHorizontalGrid" class="form-check-input" [(ngModel)]="settings.settings.volcanoPlotGrid.y">
                        <label class="form-check-label" for="showHorizontalGrid">Show Horizontal Grid</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex">
                    <div class="p-2">
                      <label for="yaxisPosition">Y-axis position</label>
                      <select id="yaxisPosition" class="form-control" multiple [(ngModel)]="settings.settings.volcanoPlotYaxisPosition">
                        <option value="left">Left</option>
                        <option value="middle">Zero</option>
                      </select>
                    </div>
                  </div>
                </ng-template>
              </li>
              <li [ngbNavItem]="'shapes'" role="presentation">
                <button ngbNavLink role="tab" aria-controls="shapesPanel">Shapes</button>
                <ng-template ngbNavContent>
                  <app-shapes (updateShapes)="updateShapes($event)"></app-shapes>
                </ng-template>
              </li>
            </ul>
            <div [ngbNavOutlet]="nav" class="mt-2" role="tabpanel"></div>
            <div ngbDropdown class="d-inline-block mt-3">
              <button
                type="button"
                class="btn btn-primary"
                id="volcanoAction"
                ngbDropdownToggle
                aria-haspopup="true"
                aria-label="Open volcano plot actions menu">
                Volcano Plot Actions
              </button>
              <div ngbDropdownMenu aria-labelledby="volcanoAction" role="menu">
                <button ngbDropdownItem (click)="drawVolcano()" role="menuitem">
                  <i class="bi bi-arrow-clockwise me-2" aria-hidden="true"></i>Redraw Plot
                </button>
                <button ngbDropdownItem (click)="openColorByCategoryModal()" role="menuitem">
                  <i class="bi bi-palette me-2" aria-hidden="true"></i>Color By Category Column
                </button>
                <button ngbDropdownItem (click)="FDRCurveSettings()" role="menuitem">
                  <i class="bi bi-graph-up me-2" aria-hidden="true"></i>Custom FDR Curve
                </button>
                <button ngbDropdownItem (click)="openCustomColor()" role="menuitem">
                  <i class="bi bi-brush me-2" aria-hidden="true"></i>Custom Legend Color
                </button>
                <button ngbDropdownItem (click)="openTextEditor()" role="menuitem">
                  <i class="bi bi-pencil-square me-2" aria-hidden="true"></i>Annotation Text Editor
                </button>
                <button ngbDropdownItem (click)="openWebLogo()" role="menuitem">
                  <i class="bi bi-image me-2" aria-hidden="true"></i>Web Logo Viewer
                </button>
                <button ngbDropdownItem (click)="openReorderTracesModal()" role="menuitem">
                  <i class="bi bi-sort-down me-2" aria-hidden="true"></i>Reorder Traces
                </button>
                <hr class="dropdown-divider">
                <button ngbDropdownItem (click)="dataService.clear()" role="menuitem" class="text-danger">
                  <i class="bi bi-trash me-2" aria-hidden="true"></i>Clear Selections
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
  </div>
</div>
